services:
  brain-panda:
    build:
      context: ./brain
      args:
        DOCKER_GID: "${DOCKER_GID:-984}"
    container_name: soul-brain-panda
    user: "${SOUL_UID:-1000}:${SOUL_GID:-1000}"
    group_add:
      - "${DOCKER_GID:-984}"
    environment:
      - NODE_NAME=panda
      - HOME=/home/soul
      - CLAUDE_MODEL=sonnet
    volumes:
      - shared:/shared
      - ./brain/nodes/panda/CLAUDE.md:/brain/CLAUDE.md:ro
      - ./brain/nodes/panda/.mcp.json:/brain/.mcp.json:ro
      - /home/masaru/.claude:/home/soul/.claude
      - ${PWD}:/soul
      - /var/run/docker.sock:/var/run/docker.sock
      - bot-commands:/shared/bot_commands
    networks:
      - soul-net
    restart: unless-stopped

  brain-gorilla:
    build:
      context: ./brain
      args:
        DOCKER_GID: "${DOCKER_GID:-984}"
    container_name: soul-brain-gorilla
    user: "${SOUL_UID:-1000}:${SOUL_GID:-1000}"
    group_add:
      - "${DOCKER_GID:-984}"
    environment:
      - NODE_NAME=gorilla
      - HOME=/home/soul
      - CLAUDE_MODEL=sonnet
    volumes:
      - shared:/shared
      - ./brain/nodes/gorilla/CLAUDE.md:/brain/CLAUDE.md:ro
      - ./brain/nodes/gorilla/.mcp.json:/brain/.mcp.json:ro
      - /home/masaru/.claude:/home/soul/.claude
      - ${PWD}:/soul
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - soul-net
    restart: unless-stopped

  brain-triceratops:
    build:
      context: ./brain
      args:
        DOCKER_GID: "${DOCKER_GID:-984}"
    container_name: soul-brain-triceratops
    user: "${SOUL_UID:-1000}:${SOUL_GID:-1000}"
    group_add:
      - "${DOCKER_GID:-984}"
    environment:
      - NODE_NAME=triceratops
      - HOME=/home/soul
      - CLAUDE_MODEL=opus
      - OWNER_DISCORD_ID=${OWNER_DISCORD_ID}
    volumes:
      - shared:/shared
      - ./brain/nodes/triceratops/CLAUDE.md:/brain/CLAUDE.md:ro
      - ./brain/nodes/triceratops/.mcp.json:/brain/.mcp.json:ro
      - /home/masaru/.claude:/home/soul/.claude
      - ${PWD}:/soul
      - /var/run/docker.sock:/var/run/docker.sock
      - openclaw-home:/openclaw:ro
      - openclaw-suggestions:/openclaw-suggestions
    networks:
      - soul-net
    restart: unless-stopped

  scheduler:
    build:
      context: ./scheduler
    container_name: soul-scheduler
    user: "${SOUL_UID:-1000}:${SOUL_GID:-1000}"
    volumes:
      - shared:/shared
    networks:
      - soul-net
    restart: unless-stopped

  web-ui:
    build:
      context: ./web-ui
    container_name: soul-web-ui
    user: "${SOUL_UID:-1000}:${SOUL_GID:-1000}"
    environment:
      - SHARED_DIR=/shared
      - PORT=3000
    volumes:
      - shared:/shared
    ports:
      - "${WEB_UI_PORT:-3000}:3000"
    networks:
      - soul-net
    restart: unless-stopped

  openclaw:
    build:
      context: ./worker/openclaw
    container_name: soul-openclaw
    env_file:
      - ./worker/openclaw/.env
    volumes:
      - openclaw-data:/app/data
      - openclaw-home:/home/openclaw/.openclaw
      - openclaw-suggestions:/suggestions
      - bot-commands:/bot_commands
    ports:
      - "${OPENCLAW_WEBHOOK_PORT:-8080}:18789"
    networks:
      - openclaw-net
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=64m

networks:
  soul-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-soul
  openclaw-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-openclaw

volumes:
  shared:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/shared
  openclaw-data:
  openclaw-home:
  openclaw-suggestions:
  bot-commands:
