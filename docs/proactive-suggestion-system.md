# Proactive Suggestion System（自発的提言システム）

## 1. 概要と目的

Open Claw botに**自発的な提言機能**を追加する。現在のSoul Systemはユーザーからのタスク投入を起点に動作するが、本システムはbotが外部データや内部状態を監視し、家族の幸福や資産に関わる情報を能動的に提供する。

### ミッションとの整合性

Soul Systemのミッション「**Masaru Tamegaiとその家族の幸福化、および資産拡大**」に直結する：

- 市場変動や重要ニュースを見逃さない（資産保全・拡大）
- 定期的なサマリーで現状把握を容易にする（意思決定の質向上）
- 緊急事態を即座に通知する（家族の安全確保）

## 2. 提言トリガー体系

提言は3種のトリガーにより生成される。

### 2.1 時間ベース

| トリガー | 頻度 | 内容 |
|---------|------|------|
| 日次資産サマリー | 毎朝9:00 JST | ポートフォリオ概況、前日比、注目銘柄 |
| 週次レポート | 毎週月曜9:00 JST | 週間パフォーマンス、トレンド分析、来週の注目イベント |
| カレンダー連動 | イベント前日 | 決算発表、経済指標発表、納税期限等のリマインダー |

### 2.2 イベントベース

| トリガー | 条件 | 内容 |
|---------|------|------|
| 市場変動検知 | 保有銘柄が1日で±3%以上変動 | 変動要因の分析と推奨アクション |
| タスク完了連鎖 | 関連タスクが複数完了 | 次のステップの提案 |
| 外部データ変化 | 監視対象のデータ更新検知 | 変化内容のサマリーと影響分析 |

### 2.3 閾値ベース

| トリガー | 閾値（仮） | 内容 |
|---------|-----------|------|
| ポートフォリオ偏差 | 目標配分から±5%乖離 | リバランス提案 |
| 支出パターン異常 | 月平均の1.5倍超 | 支出アラートと内訳分析 |
| 為替変動 | 主要通貨ペアが1日で±2%変動 | 影響評価と対応提案 |

> **注**: 閾値は仮の値。運用データに基づき調整する。

## 3. 提言カテゴリと承認フロー

### 3.1 カテゴリ定義

| カテゴリ | 承認フロー | 日次上限 | 用途 |
|---------|-----------|---------|------|
| `info` | 自動配信、承認不要 | 3件/日 | 情報提供（サマリー、リマインダー） |
| `suggestion` | タスクキュー投入→コンセンサス | 2件/日 | 提案（リバランス、最適化案） |
| `alert` | 即時通知＋**人間確認必須** | 上限なし | 緊急（大幅変動、セキュリティ） |

### 3.2 承認ルール

- **資産移動を伴う提言** → 必ず`suggestion`以上、人間承認必須
- **家族の安全に関わる提言** → `alert`、即時通知＋人間確認
- **情報提供のみ** → `info`で自動配信可

### 3.3 フロー図

```
[トリガー発火]
    ↓
[提言生成エンジン]
    ↓
[カテゴリ判定]
    ├── info → Discord通知 → 完了
    ├── suggestion → Soul inbox投入 → コンセンサス → 実行
    └── alert → Discord即時通知 → 人間確認待ち → 対応
```

## 4. 提言フォーマット標準

### 必須項目

```json
{
  "id": "suggestion_{unix_ts}_{random}",
  "category": "info | suggestion | alert",
  "title": "提言タイトル",
  "trigger": {
    "type": "time | event | threshold",
    "source": "トリガー元の識別子",
    "detected_at": "2026-02-11T09:00:00Z"
  },
  "rationale": "根拠データと分析",
  "risk_assessment": {
    "level": "low | medium | high",
    "description": "リスクの説明"
  },
  "expected_impact": "期待される効果",
  "recommended_action": "推奨アクション",
  "created_at": "ISO 8601"
}
```

### 任意項目

```json
{
  "alternatives": ["代替案1", "代替案2"],
  "related_suggestions": ["過去の関連提言ID"],
  "data_sources": ["参照データソース"],
  "expiry": "提言の有効期限（ISO 8601）"
}
```

## 5. 安全機構

### 5.1 ドライランモード

- **初期1週間**はドライランモードで稼働（ログ記録のみ、通知・タスク投入なし）
- ドライランログは `/shared/workspace/proactive-suggestions/dryrun/` に保存
- ドライラン終了時にレビューし、品質確認後にライブ化

### 5.2 段階的ライブ化

| フェーズ | 対象 | 条件 |
|---------|------|------|
| Step 1 | `info`カテゴリのみ | ドライラン期間のinfo提言精度80%以上 |
| Step 2 | `info` + `suggestion` | Step 1で1週間問題なし |
| Step 3 | 全カテゴリ | Step 2で1週間問題なし |

### 5.3 頻度制限

- `info`: 3件/日
- `suggestion`: 2件/日
- `alert`: 上限なし（ただし同一トリガーからの重複は1時間抑制）
- 全カテゴリ合計: 10件/日（alertを除く）

### 5.4 権限とデータアクセス

- 提言エンジンは**読み取り専用**でデータソースにアクセス
- 資産の移動・取引の実行は提言エンジンから直接行わない
- データアクセス範囲はホワイトリスト方式で定義

## 6. フィードバックループ

### 6.1 提言結果の記録

各提言に対し、ユーザーまたはコンセンサスの結果を記録：

| 結果 | 説明 |
|------|------|
| `adopted` | 提言が採用され実行された |
| `rejected` | 検討の上、却下 |
| `ignored` | 一定期間（72h）反応なし |
| `modified` | 修正の上で採用 |

記録先: `/shared/workspace/proactive-suggestions/feedback/`

### 6.2 月次品質レポート

- 提言の採用率・却下率・無視率
- カテゴリ別の精度分析
- 最も有用だった提言トップ3
- 改善が必要なトリガーの特定

### 6.3 閾値の自動調整

- フィードバックデータに基づき、トリガー閾値を実績ベースで調整
- 頻繁に無視される提言 → 閾値を引き上げ or 頻度を下げ
- 高採用率の提言 → 閾値維持 or 類似トリガーの追加検討

## 7. 技術アーキテクチャ概要

### 7.1 モジュール構成

```
Open Claw bot
└── ProactiveSuggestionEngine (新設)
    ├── TriggerManager          # トリガー管理・発火判定
    │   ├── TimeTrigger         # cron式スケジュール
    │   ├── EventTrigger        # イベント監視
    │   └── ThresholdTrigger    # 閾値監視
    ├── SuggestionGenerator     # 提言生成（ルールベース→将来ML）
    ├── CategoryClassifier      # カテゴリ自動判定
    ├── RateLimiter             # 頻度制限
    ├── DeliveryManager         # 配信管理
    │   ├── DiscordNotifier     # Discord通知
    │   └── SoulTaskSubmitter   # Soul Systemタスクキュー投入
    └── FeedbackCollector       # フィードバック収集・分析
```

### 7.2 エンジン方式

- **初期**: ルールベースエンジン（条件式による判定）
- **将来**: データ蓄積後にML化を検討（提言内容の最適化、トリガー精度向上）

### 7.3 外部連携

| 連携先 | 方式 | 用途 |
|--------|------|------|
| Soul System | `/shared/inbox/` へのJSON書き込み | `suggestion`タスク投入 |
| Discord | Webhook / Bot API | `info`・`alert`の通知配信 |
| 市場データAPI | REST polling | 価格・変動データ取得 |
| カレンダー | iCal / Google Calendar API | イベント取得 |

### 7.4 データフロー

```
[外部データソース] → [TriggerManager] → [発火判定]
                                            ↓
                                    [SuggestionGenerator]
                                            ↓
                                    [CategoryClassifier]
                                            ↓
                                    [RateLimiter（頻度チェック）]
                                            ↓
                              ┌─────[DeliveryManager]─────┐
                              ↓                           ↓
                     [Discord通知]              [Soul inbox投入]
                              ↓                           ↓
                     [FeedbackCollector] ← ← ← ← ← ← ← ┘
```

## 8. 実装ロードマップ

### Phase 1（1週間）: 基盤構築

- [ ] `ProactiveSuggestionEngine` モジュールの骨格作成
- [ ] ルールベース `TriggerManager` 実装（時間ベーストリガーのみ）
- [ ] `SuggestionGenerator` の基本実装
- [ ] Discord通知連携（Webhook）
- [ ] ドライランモード実装
- [ ] `/shared/workspace/proactive-suggestions/` ディレクトリ構造の整備

**成果物**: ドライランモードで時間ベースの提言がログ出力される状態

### Phase 2（1週間）: 検証・低リスクライブ化

- [ ] ドライラン結果のレビューと品質評価
- [ ] `info`カテゴリのライブ化（Discord通知開始）
- [ ] イベントベース・閾値ベーストリガーの追加
- [ ] `RateLimiter` 実装
- [ ] `suggestion`カテゴリのSoul inbox投入テスト

**成果物**: `info`提言がDiscordに配信される状態

### Phase 3（2週間〜）: フィードバック・チューニング

- [ ] `FeedbackCollector` 実装
- [ ] 月次品質レポート生成機能
- [ ] `suggestion`カテゴリのライブ化
- [ ] 閾値の実績ベース調整機能
- [ ] 全カテゴリのライブ化

**成果物**: フルスペックの提言システムが稼働

### Phase 4（将来）: ML化検討

- [ ] フィードバックデータの分析
- [ ] ML化の費用対効果評価
- [ ] MLベース提言生成のプロトタイプ（必要と判断された場合）

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026-02-11 | 初版作成（コンセンサスtask_1770801388_6108に基づく） |
